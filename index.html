<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Four Site ‚Äî NY Ops Simulation</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ====== THEME SYSTEM ====== */
:root{
  --bg:rgba(14,15,20,.96);--card:rgba(22,24,30,.97);--card2:rgba(30,32,40,.95);--border:rgba(255,255,255,.08);
  --text:#d0d0d8;--text2:#a0a0b0;--text3:#707080;--head:#ffffff;
  --accent:#f59f00;--green:#51cf66;--red:#ff6b6b;--blue:#4dabf7;--purple:#cc5de8;
  --matt:#ff6b6b;--giu:#4dabf7;--pab:#51cf66;--marc:#cc5de8;
  --shadow:0 8px 32px rgba(0,0,0,.3),0 2px 8px rgba(0,0,0,.2);
  --glass:blur(24px) saturate(1.4);--radius:12px;
}
[data-theme="light"]{
  --bg:rgba(240,242,248,.96);--card:rgba(255,255,255,.92);--card2:rgba(248,249,252,.95);--border:rgba(0,0,0,.08);
  --text:#2d3142;--text2:#5c5f77;--text3:#8b8fa3;--head:#111827;
  --shadow:0 8px 32px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.04);
  --glass:blur(24px) saturate(1.2);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;height:100dvh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
#map{width:100%;height:100vh;z-index:1;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
::-webkit-scrollbar-track{background:transparent;}

.top{position:fixed;top:0;left:0;right:0;z-index:1001;background:var(--card);backdrop-filter:var(--glass);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:10px;flex-wrap:nowrap;}
.top h1{font-size:16px;font-weight:800;color:var(--head);letter-spacing:-.4px;}
.top .sub{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;font-weight:500;}
.bdg{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;}
.bdg-g{background:rgba(81,207,102,.1);color:var(--green);border:1px solid rgba(81,207,102,.2);}
.bdg-g::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--green);animation:p 1.5s infinite;}
.bdg-o{background:rgba(245,159,0,.1);color:var(--accent);border:1px solid rgba(245,159,0,.2);}
@keyframes p{0%,100%{opacity:1}50%{opacity:.2}}
.abtn{padding:4px 8px;border-radius:6px;font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:700;cursor:pointer;border:1px solid rgba(81,207,102,.3);background:rgba(81,207,102,.08);color:var(--green);transition:all .15s;}
.abtn:hover{background:rgba(81,207,102,.18);border-color:rgba(81,207,102,.45);transform:translateY(-1px);}
.abtn:disabled{opacity:.15;cursor:not-allowed;transform:none;}
.theme-btn{width:32px;height:32px;border-radius:8px;background:var(--card2);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s;margin-left:auto;flex-shrink:0;}
.theme-btn:hover{border-color:var(--accent);transform:scale(1.08);}

.fbar{position:fixed;top:56px;left:12px;right:12px;z-index:1001;background:var(--card);backdrop-filter:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:6px 10px;display:flex;gap:5px;align-items:center;flex-wrap:wrap;box-shadow:var(--shadow);}
.fl{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:600;}
.fb{display:flex;align-items:center;gap:3px;padding:4px 8px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:1px solid;transition:all .15s;user-select:none;}
.fb.on{opacity:1;} .fb.off{opacity:.15;}
.fb.matt{border-color:var(--matt);color:var(--matt);background:rgba(255,107,107,.06);}
.fb.giu{border-color:var(--giu);color:var(--giu);background:rgba(77,171,247,.06);}
.fb.pab{border-color:var(--pab);color:var(--pab);background:rgba(81,207,102,.06);}
.fb.marc{border-color:var(--marc);color:var(--marc);background:rgba(204,93,232,.06);}
.fb.q{border-color:#444;color:#444;background:rgba(60,60,60,.06);}
.fs{width:1px;height:18px;background:var(--border);}
.tk{width:22px;height:11px;vertical-align:middle;margin-right:2px;}
.rbtn{padding:5px 10px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.08);color:var(--red);transition:all .15s;}
.rbtn:hover{background:rgba(239,68,68,.15);transform:translateY(-1px);}
.pall{padding:5px 12px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:700;cursor:pointer;border:1px solid rgba(81,207,102,.35);background:rgba(81,207,102,.1);color:var(--green);transition:all .15s;}
.pall:hover{background:rgba(81,207,102,.18);transform:translateY(-1px);}
.pall:disabled{opacity:.2;cursor:not-allowed;transform:none;}
.pall.running{background:rgba(245,159,0,.12);color:var(--accent);border-color:rgba(245,159,0,.3);animation:pp 1s infinite;}
@keyframes pp{0%,100%{opacity:1}50%{opacity:.7}}
.pfast{padding:5px 12px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:700;cursor:pointer;border:1px solid rgba(245,159,0,.35);background:rgba(245,159,0,.1);color:var(--accent);transition:all .15s;}
.pfast:hover{background:rgba(245,159,0,.2);transform:translateY(-1px);}
.pfast:disabled{opacity:.2;cursor:not-allowed;transform:none;}
.spd-strip{display:flex;gap:3px;align-items:center;}
.spd-strip .sl{margin-right:2px;}
.gs{padding:4px 7px;border-radius:6px;font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text3);transition:all .12s;min-width:24px;text-align:center;}
.gs:hover{border-color:var(--accent);color:var(--accent);}
.gs.on{background:rgba(245,159,0,.12);color:var(--accent);border-color:rgba(245,159,0,.28);}

.ptog{position:fixed;z-index:1002;width:30px;height:30px;border-radius:8px;background:var(--card);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text3);transition:all .15s;box-shadow:var(--shadow);}
.ptog:hover{border-color:var(--accent);color:var(--accent);transform:scale(1.05);}
.ptog-l{bottom:16px;left:16px;} .ptog-r{top:94px;right:16px;}
.ptog-l.open{left:293px;} .ptog-r.open{right:362px;}

.lp{position:fixed;bottom:14px;left:14px;z-index:1000;background:var(--card);backdrop-filter:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:16px;width:275px;max-height:calc(100vh - 100px);overflow-y:auto;transition:transform .3s cubic-bezier(.4,0,.2,1),opacity .2s;box-shadow:var(--shadow);}
.lp.hidden{transform:translateX(-300px);opacity:0;pointer-events:none;}
.pt{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:8px;}
.sr{display:flex;justify-content:space-between;padding:5px 0;font-size:12px;}
.sl{color:var(--text2);} .sv{font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--head);font-size:12px;}
.dv{height:1px;background:var(--border);margin:10px 0;}
.pb{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:6px;}
.pfl{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),#2b8a3e);transition:width .3s;width:0%;}

/* Collapsible section toggle */
.sec-tog{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;padding:3px 0;margin-bottom:6px;}
.sec-tog:hover .pt{color:var(--text2);}
.sec-tog .sec-chev{font-size:10px;color:var(--text3);transition:transform .25s cubic-bezier(.4,0,.2,1);}
.sec-tog.closed .sec-chev{transform:rotate(-90deg);}
.sec-body{transition:max-height .3s cubic-bezier(.4,0,.2,1),opacity .2s;overflow:hidden;max-height:500px;opacity:1;}
.sec-body.hide{max-height:0;opacity:0;margin:0;padding:0;flex:0!important;min-height:0!important;}

.scn-btn{display:block;width:100%;padding:8px 11px;margin-bottom:4px;border-radius:8px;font-size:11px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card2);color:var(--text2);text-align:left;transition:all .15s;}
.scn-btn:hover{border-color:var(--accent);color:var(--accent);transform:translateX(2px);}
.scn-btn.act{border-color:var(--accent);background:rgba(245,159,0,.08);color:var(--accent);}
.scn-slider label{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;display:block;margin-bottom:3px;}
.scn-slider input[type=range]{width:100%;height:4px;-webkit-appearance:none;background:var(--border);border-radius:2px;outline:none;}
.scn-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;}

/* Variable toggles */
.var-tog{display:flex;align-items:center;gap:6px;padding:7px 9px;margin-bottom:4px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;cursor:pointer;border:1px solid var(--border);background:var(--card2);color:var(--text2);transition:all .15s;user-select:none;}
.var-tog:hover{border-color:rgba(255,255,255,.15);transform:translateX(2px);}
.var-tog.on{border-color:#fcc419;background:rgba(252,196,25,.08);color:#fcc419;}
.var-tog .vdot{width:8px;height:8px;border-radius:50%;border:2px solid var(--text3);transition:all .15s;}
.var-tog.on .vdot{background:#fcc419;border-color:#fcc419;}

.csv-zone{margin-top:8px;border:2px dashed var(--border);border-radius:var(--radius);padding:14px;text-align:center;cursor:pointer;transition:all .2s;}
.csv-zone:hover,.csv-zone.drag{border-color:var(--accent);background:rgba(245,159,0,.04);}
.csv-zone p{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;line-height:1.5;}
.csv-zone input{display:none;}
.csv-status{font-size:10px;color:var(--green);font-family:'JetBrains Mono',monospace;margin-top:4px;}

.rp{position:fixed;top:92px;right:14px;bottom:14px;z-index:1000;background:var(--card);backdrop-filter:var(--glass);border:1px solid var(--border);border-radius:var(--radius);width:340px;overflow:hidden;display:flex;flex-direction:column;transition:transform .3s cubic-bezier(.4,0,.2,1),opacity .2s;box-shadow:var(--shadow);}
.rp.hidden{transform:translateX(370px);opacity:0;pointer-events:none;}
.rp-head{padding:12px 14px;border-bottom:1px solid var(--border);flex-shrink:0;}
.rp-scroll{flex:1;overflow-y:auto;padding:8px 14px 8px;min-height:0;transition:all .25s cubic-bezier(.4,0,.2,1);}
.rp-scroll.hide{flex:0!important;max-height:0!important;padding:0 14px!important;overflow:hidden!important;opacity:0;}
.rp-foot{padding:12px 14px 14px;border-top:1px solid var(--border);flex-shrink:0;background:var(--card);}
.wx-bar{display:flex;gap:5px;flex-wrap:wrap;margin-top:8px;}
.wx{display:flex;align-items:center;gap:4px;padding:5px 9px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card2);color:var(--text3);transition:all .15s;user-select:none;}
.wx:hover{border-color:var(--text2);transform:translateY(-1px);}
.wx.on{border-color:#60a5fa;background:rgba(96,165,250,.1);color:#60a5fa;}
.wx.on.bad{border-color:var(--red);background:rgba(255,107,107,.1);color:var(--red);}
.wx .wdot{width:7px;height:7px;border-radius:50%;border:1.5px solid var(--text3);transition:all .12s;}
.wx.on .wdot{background:#60a5fa;border-color:#60a5fa;}
.wx.on.bad .wdot{background:var(--red);border-color:var(--red);}

.dc{background:var(--card2);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;overflow:hidden;transition:all .2s;}
.dc.sun{opacity:.2;pointer-events:none;}
.dc.act{border-color:var(--accent);background:rgba(245,159,0,.04);}
.dc.done{border-color:rgba(81,207,102,.2);}
.dc-head{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.dc-head:hover{background:rgba(128,128,128,.04);}
.dn{font-size:13px;font-weight:700;color:var(--head);} .dd{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--text3);}
.dtg{font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--accent);background:rgba(245,159,0,.1);padding:3px 8px;border-radius:6px;}
.dc-chev{font-size:10px;color:var(--text3);transition:transform .25s cubic-bezier(.4,0,.2,1);}
.dc.open .dc-chev{transform:rotate(180deg);}
.dc-body{max-height:0;overflow:hidden;transition:max-height .3s cubic-bezier(.4,0,.2,1);padding:0 12px;}
.dc.open .dc-body{max-height:360px;padding:0 12px 10px;}
.di{display:flex;gap:6px;flex-wrap:wrap;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text3);margin-bottom:6px;}
.di b{color:var(--text);font-weight:500;}
.dr{font-size:12px;font-family:'JetBrains Mono',monospace;} .dr .cc{color:var(--green);font-weight:700;font-size:14px;}
.el{max-height:50px;overflow-y:auto;font-size:9px;color:var(--text3);line-height:1.5;font-family:'JetBrains Mono',monospace;margin-top:5px;}
.el .eg{color:var(--green);} .el .ew{color:#fcc419;} .el .eb{color:var(--red);}
.dp{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:5px;}
.dpf{height:100%;border-radius:2px;background:var(--green);width:0%;transition:width .15s;}
.dbt{display:flex;gap:4px;margin-top:7px;align-items:center;}
.b{padding:6px 11px;border-radius:8px;font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.bp{background:var(--green);color:#000;} .bp:hover{filter:brightness(1.1);transform:translateY(-1px);} .bp:disabled{background:var(--border);color:var(--text3);cursor:not-allowed;transform:none;}
.bru{background:rgba(245,159,0,.08);color:var(--accent);border:1px solid rgba(245,159,0,.18);} .bru:hover{background:rgba(245,159,0,.15);transform:translateY(-1px);} .bru:disabled{opacity:.15;cursor:not-allowed;}
.bs{padding:4px 7px;border-radius:6px;font-size:9px;font-family:'JetBrains Mono',monospace;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text3);transition:all .12s;margin-left:auto;}
.bs.on{background:rgba(245,159,0,.1);color:var(--accent);border-color:rgba(245,159,0,.2);}
.expand-all{font-size:10px;color:var(--text3);cursor:pointer;font-family:'JetBrains Mono',monospace;padding:4px 9px;border:1px solid var(--border);border-radius:8px;background:transparent;float:right;transition:all .12s;}
.expand-all:hover{color:var(--accent);border-color:var(--accent);}

.sb{background:rgba(245,159,0,.05);border:1px solid rgba(245,159,0,.12);border-radius:10px;padding:14px 10px;display:flex;justify-content:space-around;text-align:center;}
.sb .big{font-size:20px;font-weight:800;color:var(--accent);font-family:'JetBrains Mono',monospace;line-height:1.3;}
.sb .lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;font-weight:600;}
.sb-est{background:rgba(77,171,247,.05);border:1px solid rgba(77,171,247,.12);}

.est-box{margin-top:8px;padding:10px 12px;border-radius:10px;background:rgba(77,171,247,.04);border:1px solid rgba(77,171,247,.1);font-family:'JetBrains Mono',monospace;}
.est-box .est-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:4px 0;}
.est-box .est-lbl{color:var(--text2);}
.est-box .est-val{font-weight:700;color:var(--head);}
.est-box .est-val.warn{color:var(--accent);}
.est-box .est-val.crit{color:var(--red);}
.est-box .est-val.good{color:var(--green);}
.est-box .est-title{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;font-weight:600;}

.done-banner{display:none;margin-top:8px;background:linear-gradient(135deg,rgba(81,207,102,.1),rgba(81,207,102,.03));border:1px solid rgba(81,207,102,.25);border-radius:10px;padding:16px;text-align:center;animation:banIn .4s ease;}
.done-banner.show{display:block;}
.done-banner .db-big{font-size:28px;font-weight:800;color:var(--green);font-family:'JetBrains Mono',monospace;margin-top:4px;}
.done-banner .db-label{font-size:11px;color:rgba(81,207,102,.8);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:4px;font-weight:700;}
.done-banner .db-detail{font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;margin-top:8px;line-height:1.8;}
.done-banner .db-detail span{color:var(--head);}
@keyframes banIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Dropout warning */
.dropout-warn{background:rgba(255,107,107,.06);border:1px solid rgba(255,107,107,.15);border-radius:8px;padding:8px 11px;margin-top:7px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--red);display:none;}
.dropout-warn.show{display:block;}

.county-label{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(0,0,0,.15);}
.leaflet-popup-content-wrapper{background:var(--card)!important;color:var(--text)!important;border:1px solid var(--border)!important;border-radius:10px!important;font-family:'Inter',sans-serif!important;box-shadow:var(--shadow)!important;}
.leaflet-popup-tip{background:var(--card)!important;}
.leaflet-popup-content{font-size:11px!important;line-height:1.5!important;margin:10px 13px!important;}

/* Per-day condition toggles */
.dc-conds{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:7px;padding-bottom:7px;border-bottom:1px solid var(--border);}
.dc-ct{display:flex;align-items:center;gap:3px;padding:4px 8px;border-radius:6px;font-size:9px;font-family:'JetBrains Mono',monospace;cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text3);transition:all .12s;user-select:none;position:relative;}
.dc-ct:hover{border-color:var(--text2);}
.dc-ct.on{border-color:#fcc419;background:rgba(252,196,25,.08);color:#fcc419;}
.dc-ct .cdot{width:6px;height:6px;border-radius:50%;border:1.5px solid var(--text3);transition:all .12s;}
.dc-ct.on .cdot{background:#fcc419;border-color:#fcc419;}

/* Info tooltip */
.ifo{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(--border);color:var(--text3);font-size:8px;font-weight:700;cursor:help;margin-left:3px;position:relative;}
.ifo:hover{color:var(--accent);background:rgba(245,159,0,.12);}
.ifo .tip{display:none;position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:210px;font-size:9px;font-weight:400;color:var(--text2);line-height:1.5;font-family:'JetBrains Mono',monospace;box-shadow:var(--shadow);z-index:9999;white-space:normal;text-align:left;}
.ifo:hover .tip{display:block;}

/* ====== TABLET ====== */
@media(max-width:900px){
  .top{padding:8px 10px;gap:6px;}
  .top h1{font-size:13px;}
  .top .sub{font-size:8px;}
  .fbar{top:48px;padding:5px 6px;gap:3px;overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;}
  .fbar::-webkit-scrollbar{display:none;}
  .fb{font-size:9px;padding:4px 7px;white-space:nowrap;min-height:32px;}
  .tk{width:16px;height:8px;}
  .pall,.pfast,.rbtn{font-size:9px;padding:4px 9px;white-space:nowrap;min-height:32px;}
  .gs{font-size:8px;padding:3px 6px;min-width:20px;min-height:28px;}
  .lp{left:6px;bottom:6px;width:calc(50vw - 10px);max-height:45vh;padding:10px;border-radius:10px;z-index:1001;}
  .rp{right:6px;bottom:6px;top:auto;width:calc(50vw - 10px);max-height:45vh;border-radius:10px;z-index:1001;}
  .rp.hidden{transform:translateX(100vw);}
  .lp.hidden{transform:translateX(-100vw);}
  .ptog{width:36px;height:36px;font-size:14px;border-radius:10px;}
  .ptog-l{bottom:auto;top:92px;left:6px;} .ptog-r{top:92px;right:6px;}
  .ptog-l.open{left:calc(50vw - 4px);} .ptog-r.open{right:calc(50vw - 4px);}
  .bdg{font-size:8px;padding:3px 7px;}
  .abtn{font-size:7px;padding:3px 6px;}
  #addBtns{display:none!important;}
  .pt{font-size:10px;letter-spacing:1px;}
  .sr{font-size:11px;padding:3px 0;}
  .sv{font-size:11px;}
  .scn-btn{font-size:10px;padding:7px 9px;min-height:36px;}
  .var-tog{font-size:9px;padding:6px 8px;min-height:36px;}
  .dc-head{padding:8px 10px;min-height:40px;}
  .dn{font-size:12px;}
  .dd{font-size:10px;}
  .wx{font-size:9px;padding:4px 7px;min-height:30px;}
  .est-box .est-row{font-size:10px;padding:2px 0;}
  .sb .big{font-size:16px;}
  .sb{padding:10px 6px;}
  .sb-est{padding:8px 6px;}
  .sb-est .big{font-size:14px!important;}
  .rp-foot{padding:8px 10px 10px;max-height:42vh;overflow-y:auto;}
  .theme-btn{width:30px;height:30px;font-size:14px;}
  .b{padding:5px 9px;min-height:32px;}
}

/* ====== PHONE ====== */
@media(max-width:480px){
  .top{padding:6px 8px;gap:4px;}
  .top h1{font-size:12px;}
  .top .sub{font-size:7px;}
  .fbar{top:42px;padding:4px 5px;gap:2px;}
  .fb{font-size:8px;padding:3px 5px;}
  .pall,.pfast{font-size:8px;padding:3px 7px;}
  .rbtn{font-size:8px;padding:3px 7px;}
  .spd-strip{display:none;}
  /* Stack panels ‚Äî only one visible at a time */
  .lp{left:4px;right:4px;bottom:4px;width:auto;max-height:42vh;padding:10px;z-index:1001;}
  .rp{left:4px;right:4px;bottom:4px;width:auto;max-height:42vh;top:auto;z-index:1001;}
  .lp.hidden{transform:translateY(100vh);}
  .rp.hidden{transform:translateY(100vh);}
  .ptog{width:40px;height:40px;font-size:16px;border-radius:12px;}
  .ptog-l{bottom:auto;top:82px;left:4px;} .ptog-r{top:82px;right:4px;}
  .ptog-l.open{left:4px;bottom:auto;top:82px;} .ptog-r.open{right:4px;top:82px;}
  /* Compact footer for phone */
  .rp-foot{padding:6px 8px 8px;max-height:38vh;overflow-y:auto;}
  .sb{padding:8px 4px;border-radius:8px;}
  .sb .big{font-size:14px;}
  .sb .lbl{font-size:7px;}
  .sb-est .big{font-size:12px!important;}
  .est-box{padding:6px 8px;margin-top:5px;}
  .est-box .est-row{font-size:9px;padding:2px 0;}
  .est-box .est-title{font-size:7px;}
  .est-box .est-lbl{font-size:9px;}
  .wx{font-size:8px;padding:3px 5px;}
  .wx-bar{gap:3px;margin-top:5px;}
  .dc-head{padding:7px 8px;}
  .dn{font-size:11px;} .dd{font-size:9px;}
  .rp-head{padding:8px 10px;}
  .rp-scroll{padding:6px 10px;}
  .scn-btn{padding:6px 7px;font-size:9px;}
  .var-tog{padding:5px 6px;font-size:8px;}
  .sec-tog .pt{font-size:9px;}
  .expand-all{font-size:8px;padding:3px 6px;}
  .done-banner{padding:10px;}
  .done-banner .db-big{font-size:22px;}
  .done-banner .db-detail{font-size:9px;}
  /* Ensure touch targets */
  .fb,.wx,.var-tog,.scn-btn,.dc-head,.b,.gs,.theme-btn,.ptog{touch-action:manipulation;}
}
</style>
</head>
<body>
<div class="top">
  <div style="flex:1;min-width:0;"><h1>Four Site ‚Äî NY Ops Simulation</h1><div class="sub">Nassau & Suffolk ¬∑ <span id="subCount">500</span> Inspections ¬∑ March 2‚Äì14, 2026</div></div>
  <span class="bdg bdg-g" id="sBdg">READY</span>
  <span class="bdg bdg-o" id="rBdg">500 REMAINING</span>
  <div id="addBtns" style="display:flex;gap:2px;">
    <button onclick="addIns(100)" class="abtn" title="Add 100 inspections">+100</button>
    <button onclick="addIns(200)" class="abtn" title="Add 200 inspections">+200</button>
    <button onclick="addIns(500)" class="abtn" title="Add 500 inspections">+500</button>
  </div>
  <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle light/dark theme">üåô</button>
</div>
<div class="fbar">
  <span class="fl">Team:</span>
  <div class="fb matt on" onclick="togF('matt')" id="fb-matt"><svg class="tk" viewBox="0 0 32 14"><polygon points="1,10 4,3 10,1 23,1 29,4 31,10 29,12 1,12" fill="var(--matt)" fill-opacity=".75" stroke="#fff" stroke-width=".5"/><circle cx="7" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><circle cx="25" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><polygon points="4,3 10,1 10,8 5.5,8" fill="rgba(255,255,255,.1)"/></svg>MATT</div>
  <div class="fb giu on" onclick="togF('giuseppe')" id="fb-giuseppe"><svg class="tk" viewBox="0 0 32 14"><polygon points="1,10 4,3 10,1 23,1 29,4 31,10 29,12 1,12" fill="var(--giu)" fill-opacity=".75" stroke="#fff" stroke-width=".5"/><circle cx="7" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><circle cx="25" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><polygon points="4,3 10,1 10,8 5.5,8" fill="rgba(255,255,255,.1)"/></svg>GIUSEPPE</div>
  <div class="fb pab on" onclick="togF('pablo')" id="fb-pablo"><svg class="tk" viewBox="0 0 32 14"><polygon points="1,10 4,3 10,1 23,1 29,4 31,10 29,12 1,12" fill="var(--pab)" fill-opacity=".75" stroke="#fff" stroke-width=".5"/><circle cx="7" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><circle cx="25" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><polygon points="4,3 10,1 10,8 5.5,8" fill="rgba(255,255,255,.1)"/></svg>PABLO</div>
  <div class="fb marc on" onclick="togF('marc')" id="fb-marc"><svg class="tk" viewBox="0 0 32 14"><polygon points="1,10 4,3 10,1 23,1 29,4 31,10 29,12 1,12" fill="var(--marc)" fill-opacity=".75" stroke="#fff" stroke-width=".5"/><circle cx="7" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><circle cx="25" cy="12" r="2" fill="#111" stroke="#fff" stroke-width=".3"/><polygon points="4,3 10,1 10,8 5.5,8" fill="rgba(255,255,255,.1)"/></svg>MARC</div>
  <div class="fs"></div>
  <div style="display:flex;align-items:center;gap:3px;">
    <span class="fl">Total:</span>
    <input type="number" id="insCount" value="500" min="50" max="2000" step="50" onchange="setInsCount(this.value)" style="width:52px;background:var(--card2);border:1px solid var(--border);border-radius:6px;padding:3px 5px;color:var(--accent);font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:700;text-align:center;outline:none;">
  </div>
  <div class="fs"></div>
  <button class="pall" id="pallBtn" onclick="playAll()">‚ñ∂‚ñ∂ PLAY ALL</button>
  <button class="pfast" id="pfastBtn" onclick="playAllFast()">‚ö° FAST</button>
  <div class="fs"></div>
  <div class="spd-strip">
    <span class="fl">Speed:</span>
    <div class="gs on" onclick="setGSpd(1,this)">1x</div>
    <div class="gs" onclick="setGSpd(2,this)">2x</div>
    <div class="gs" onclick="setGSpd(3,this)">3x</div>
    <div class="gs" onclick="setGSpd(4,this)">4x</div>
    <div class="gs" onclick="setGSpd(5,this)">5x</div>
  </div>
  <div class="fs"></div>
  <button class="rbtn" onclick="fullReset()">‚ü≤ RESET</button>
</div>

<button class="ptog ptog-l open" id="togL" onclick="togglePanel('l')">‚óÄ</button>
<button class="ptog ptog-r open" id="togR" onclick="togglePanel('r')">‚ñ∂</button>

<div id="map"></div>

<div class="lp" id="lpanel">
  <div class="sec-tog" id="mpTog" onclick="togSection('mp')">
    <div class="pt" style="margin:0">Mission Progress</div>
    <span class="sec-chev">‚ñº</span>
  </div>
  <div class="sec-body" id="mpBody">
    <div class="sr"><span class="sl">Total</span><span class="sv" id="gT">500</span></div>
    <div class="sr"><span class="sl">Completed</span><span class="sv" id="gC" style="color:var(--green)">0</span></div>
    <div class="sr"><span class="sl">Remaining</span><span class="sv" id="gR">500</span></div>
    <div class="pb"><div class="pfl" id="gP"></div></div>
    <div class="dv"></div>
    <div class="pt">Inspector Totals</div>
    <div class="sr"><span class="sl" style="color:var(--matt)">Matt</span><span class="sv" id="tM">0</span></div>
    <div class="sr"><span class="sl" style="color:var(--giu)">Giuseppe</span><span class="sv" id="tG">0</span></div>
    <div class="sr"><span class="sl" style="color:var(--pab)">Pablo</span><span class="sv" id="tP">0</span></div>
    <div class="sr"><span class="sl" style="color:var(--marc)">Marc</span><span class="sv" id="tMa">0</span></div>
    <div class="dropout-warn" id="dropWarn">‚ö† Inspector(s) removed ‚Äî reduced team capacity</div>
  </div>
  <div class="dv"></div>

  <div class="pt">Scenario</div>
  <button class="scn-btn act" id="sc-dense" onclick="setScenario('dense')">üèòÔ∏è Dense Cluster</button>
  <button class="scn-btn" id="sc-standard" onclick="setScenario('standard')">üìç Standard Spread</button>
  <button class="scn-btn" id="sc-wide" onclick="setScenario('wide')">üó∫Ô∏è Wide Spread</button>
  <div class="scn-slider" style="margin-top:6px;">
    <label>East Suffolk spread: <span id="spreadVal" style="color:var(--accent);font-weight:600;">20%</span></label>
    <input type="range" min="0" max="100" value="20" id="spreadSlider" oninput="liveSpread(this.value)">
    <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-top:2px;"><span>Tight cluster</span><span>Full east to Riverhead</span></div>
  </div>

  <div class="dv"></div>
  <div class="pt">Persistent Conditions</div>
  <div style="font-size:9px;color:var(--text3);margin-bottom:6px;font-family:'JetBrains Mono',monospace;">These apply EVERY day on top of random variables</div>
  <div class="var-tog" id="vt-slow" onclick="togVar('slow')"><div class="vdot"></div>üê¢ Inspectors not at peak (‚àí12% output)</div>
  <div class="var-tog" id="vt-late" onclick="togVar('late')"><div class="vdot"></div>‚è∞ Late starts every day (‚àí8% output)</div>
  <div class="var-tog" id="vt-access" onclick="togVar('access')"><div class="vdot"></div>üîí High gate/access issues (‚àí10%, +3 skips/day)</div>

  <div class="dv"></div>
  <div class="pt">Day Variables</div>
  <div id="vP" style="font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;line-height:1.5;">‚Äî</div>

  <div class="dv"></div>
  <div class="pt">Upload Real Addresses</div>
  <div class="csv-zone" id="csvZone" onclick="document.getElementById('csvInput').click()">
    <div style="font-size:16px">üìÑ</div>
    <p>Drop CSV or click<br>lat, lng, address, type</p>
    <input type="file" id="csvInput" accept=".csv,.tsv">
  </div>
  <div class="csv-status" id="csvStatus"></div>
</div>

<div class="rp" id="rpanel">
  <div class="rp-head">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="sec-tog" id="doTog" onclick="togSection('do')" style="flex:1;margin:0;">
        <div class="pt" style="margin:0">Daily Ops</div>
        <span class="sec-chev">‚ñº</span>
      </div>
      <button class="expand-all" id="expAll" onclick="toggleAllDays()" style="margin-left:6px;">‚ñº Expand All</button>
    </div>
    <div class="wx-bar">
      <span class="fl" style="line-height:20px;">Weather:</span>
      <div class="wx" id="wx-rain" onclick="togWx('rain')"><div class="wdot"></div>üåßÔ∏è Rain</div>
      <div class="wx" id="wx-wind" onclick="togWx('wind')"><div class="wdot"></div>üí® Wind</div>
      <div class="wx" id="wx-fog" onclick="togWx('fog')"><div class="wdot"></div>üå´Ô∏è Fog</div>
      <div class="wx" id="wx-blizzard" onclick="togWx('blizzard')"><div class="wdot"></div>‚ùÑÔ∏è Blizzard</div>
      <div class="wx" id="wx-clear" onclick="togWx('clear')"><div class="wdot"></div>‚òÄÔ∏è Clear</div>
    </div>
  </div>
  <div class="rp-scroll" id="doBody">
    <div id="dB"></div>
  </div>
  <div class="rp-foot">
    <div class="sb">
      <div><div class="lbl">Finish</div><div class="big" id="pF">Day 9</div></div>
      <div><div class="lbl">Done</div><div class="big" id="pC">0</div></div>
      <div><div class="lbl">Left</div><div class="big" id="pR">500</div></div>
    </div>
    <div class="est-box" id="estBox">
      <div class="est-title">Estimated Pace</div>
      <div class="est-row"><span class="est-lbl">Active team</span><span class="est-val" id="estTeam">4 inspectors</span></div>
      <div class="est-row"><span class="est-lbl">Daily output</span><span class="est-val" id="estDaily">~56‚Äì68/day</span></div>
      <div class="est-row"><span class="est-lbl">Est. finish</span><span class="est-val good" id="estFinish">Day 8‚Äì9</span></div>
      <div class="est-row"><span class="est-lbl">Buffer days</span><span class="est-val good" id="estBuffer">3‚Äì4 days</span></div>
      <div style="height:1px;background:var(--border);margin:6px 0;"></div>
      <div class="est-row"><span class="est-lbl">Day lag from conditions</span><span class="est-val" id="estLag" style="font-size:13px;">+0 days</span></div>
    </div>
    <div class="sb sb-est" id="sbEst" style="margin-top:8px;">
      <div><div class="lbl">Est. Finish</div><div class="big" id="eF" style="color:var(--blue);">Day 9</div></div>
      <div><div class="lbl">Lag</div><div class="big" id="eLag" style="color:var(--blue);">+0</div></div>
      <div><div class="lbl">Overflow</div><div class="big" id="eOver" style="color:var(--green);">None</div></div>
    </div>
    <div class="done-banner" id="doneBanner">
      <div class="db-label">Mission Complete</div>
      <div class="db-big" id="dbDays">‚Äî</div>
      <div class="db-detail" id="dbDetail"></div>
    </div>
  </div>
</div>

<script>
// ============================================================
// REAL COORDS DATABASE
// ============================================================
const RC={nassau:[
{lat:40.7062,lng:-73.6187,a:"Hempstead",s:"Front St"},{lat:40.7054,lng:-73.6235,a:"Hempstead",s:"Main St"},{lat:40.7120,lng:-73.6180,a:"Hempstead",s:"Fulton Ave"},{lat:40.7098,lng:-73.6305,a:"Hempstead",s:"Greenwich St"},{lat:40.7145,lng:-73.6250,a:"Hempstead",s:"Cathedral Ave"},{lat:40.7030,lng:-73.6150,a:"Hempstead",s:"Terrace Ave"},{lat:40.7180,lng:-73.6200,a:"Hempstead",s:"Clinton St"},{lat:40.7005,lng:-73.6280,a:"Hempstead",s:"Bedell St"},
{lat:40.7268,lng:-73.6340,a:"Garden City",s:"Franklin Ave"},{lat:40.7300,lng:-73.6380,a:"Garden City",s:"Hilton Ave"},{lat:40.7255,lng:-73.6420,a:"Garden City",s:"Stewart Ave"},{lat:40.7320,lng:-73.6290,a:"Garden City",s:"Nassau Blvd"},{lat:40.7230,lng:-73.6360,a:"Garden City",s:"Cherry Valley Ave"},
{lat:40.7490,lng:-73.6395,a:"Mineola",s:"Jericho Tpke"},{lat:40.7510,lng:-73.6440,a:"Mineola",s:"Main St"},{lat:40.7465,lng:-73.6380,a:"Mineola",s:"Old Country Rd"},{lat:40.7530,lng:-73.6410,a:"Mineola",s:"Roslyn Rd"},{lat:40.7480,lng:-73.6350,a:"Mineola",s:"Willis Ave"},
{lat:40.6576,lng:-73.5833,a:"Freeport",s:"N Main St"},{lat:40.6555,lng:-73.5870,a:"Freeport",s:"Merrick Rd"},{lat:40.6600,lng:-73.5810,a:"Freeport",s:"Atlantic Ave"},{lat:40.6530,lng:-73.5850,a:"Freeport",s:"Guy Lombardo Ave"},{lat:40.6620,lng:-73.5790,a:"Freeport",s:"Church St"},
{lat:40.7630,lng:-73.5250,a:"Hicksville",s:"Broadway"},{lat:40.7660,lng:-73.5280,a:"Hicksville",s:"Old Country Rd"},{lat:40.7610,lng:-73.5220,a:"Hicksville",s:"Jerusalem Ave"},{lat:40.7680,lng:-73.5310,a:"Hicksville",s:"Woodbury Rd"},{lat:40.7590,lng:-73.5190,a:"Hicksville",s:"Newbridge Rd"},{lat:40.7700,lng:-73.5260,a:"Hicksville",s:"Duffy Ave"},{lat:40.7645,lng:-73.5300,a:"Hicksville",s:"W John St"},
{lat:40.7250,lng:-73.5140,a:"Levittown",s:"Hempstead Tpke"},{lat:40.7280,lng:-73.5170,a:"Levittown",s:"Center Ln"},{lat:40.7310,lng:-73.5200,a:"Levittown",s:"Gardiners Ave"},{lat:40.7220,lng:-73.5110,a:"Levittown",s:"Abbey Ln"},{lat:40.7340,lng:-73.5150,a:"Levittown",s:"Wolcott Rd"},
{lat:40.6565,lng:-73.6090,a:"Baldwin",s:"Grand Ave"},{lat:40.6590,lng:-73.6050,a:"Baldwin",s:"Merrick Rd"},{lat:40.6540,lng:-73.6120,a:"Baldwin",s:"Sunrise Hwy"},
{lat:40.6620,lng:-73.5510,a:"Merrick",s:"Merrick Ave"},{lat:40.6650,lng:-73.5540,a:"Merrick",s:"Sunrise Hwy"},{lat:40.6590,lng:-73.5480,a:"Merrick",s:"Smith St"},
{lat:40.6840,lng:-73.5100,a:"Wantagh",s:"Wantagh Ave"},{lat:40.6810,lng:-73.5070,a:"Wantagh",s:"Sunrise Hwy"},{lat:40.6870,lng:-73.5130,a:"Wantagh",s:"Jerusalem Ave"},
{lat:40.6810,lng:-73.4720,a:"Massapequa",s:"Broadway"},{lat:40.6780,lng:-73.4690,a:"Massapequa",s:"Sunrise Hwy"},{lat:40.6840,lng:-73.4750,a:"Massapequa",s:"Hicksville Rd"},{lat:40.6760,lng:-73.4660,a:"Massapequa",s:"Merrick Rd"},{lat:40.6870,lng:-73.4780,a:"Massapequa",s:"Park Blvd"},
{lat:40.7760,lng:-73.4670,a:"Plainview",s:"Old Country Rd"},{lat:40.7790,lng:-73.4700,a:"Plainview",s:"Woodbury Rd"},{lat:40.7730,lng:-73.4640,a:"Plainview",s:"Manetto Hill Rd"},
{lat:40.7350,lng:-73.6880,a:"New Hyde Park",s:"Jericho Tpke"},{lat:40.7320,lng:-73.6850,a:"New Hyde Park",s:"Hillside Ave"},{lat:40.7380,lng:-73.6910,a:"New Hyde Park",s:"Clinch Ave"},
{lat:40.7870,lng:-73.7280,a:"Great Neck",s:"Middle Neck Rd"},{lat:40.7840,lng:-73.7250,a:"Great Neck",s:"Northern Blvd"},
{lat:40.6690,lng:-73.4880,a:"Seaford",s:"Merrick Rd"},{lat:40.6720,lng:-73.4910,a:"Seaford",s:"Sunrise Hwy"},
{lat:40.5892,lng:-73.6550,a:"Long Beach",s:"Park Ave"},
],suffolkWest:[
{lat:40.7326,lng:-73.4454,a:"Farmingdale",s:"Main St"},{lat:40.7350,lng:-73.4480,a:"Farmingdale",s:"Conklin St"},{lat:40.7300,lng:-73.4430,a:"Farmingdale",s:"Fulton St"},{lat:40.7380,lng:-73.4510,a:"Farmingdale",s:"Broad Hollow Rd"},
{lat:40.6956,lng:-73.3257,a:"Babylon",s:"Deer Park Ave"},{lat:40.6980,lng:-73.3290,a:"Babylon",s:"Main St"},{lat:40.6930,lng:-73.3220,a:"Babylon",s:"Railroad Ave"},{lat:40.7010,lng:-73.3310,a:"Babylon",s:"Park Ave"},
{lat:40.6870,lng:-73.3735,a:"Lindenhurst",s:"Wellwood Ave"},{lat:40.6900,lng:-73.3760,a:"Lindenhurst",s:"Sunrise Hwy"},{lat:40.6840,lng:-73.3710,a:"Lindenhurst",s:"S Broadway"},
{lat:40.7252,lng:-73.2455,a:"Bay Shore",s:"Main St"},{lat:40.7280,lng:-73.2480,a:"Bay Shore",s:"E Main St"},{lat:40.7220,lng:-73.2430,a:"Bay Shore",s:"Union Blvd"},{lat:40.7310,lng:-73.2510,a:"Bay Shore",s:"Fifth Ave"},{lat:40.7190,lng:-73.2400,a:"Bay Shore",s:"Brentwood Rd"},
{lat:40.7060,lng:-73.3060,a:"West Islip",s:"Higbie Ln"},{lat:40.7090,lng:-73.3090,a:"West Islip",s:"Montauk Hwy"},
{lat:40.7932,lng:-73.4152,a:"Melville",s:"Walt Whitman Rd"},{lat:40.7900,lng:-73.4120,a:"Melville",s:"Old Country Rd"},
{lat:40.7620,lng:-73.3230,a:"Deer Park",s:"Deer Park Ave"},{lat:40.7590,lng:-73.3200,a:"Deer Park",s:"Grand Blvd"},{lat:40.7650,lng:-73.3260,a:"Deer Park",s:"Commack Rd"},
{lat:40.7000,lng:-73.3530,a:"N Amityville",s:"Broadway"},{lat:40.7030,lng:-73.3560,a:"N Amityville",s:"Sunrise Hwy"},
{lat:40.8558,lng:-73.2006,a:"Smithtown",s:"Main St"},{lat:40.8530,lng:-73.1980,a:"Smithtown",s:"Maple Ave"},{lat:40.8585,lng:-73.2030,a:"Smithtown",s:"Landing Ave"},{lat:40.8500,lng:-73.1950,a:"Smithtown",s:"Edgewater Ave"},{lat:40.8470,lng:-73.1920,a:"Smithtown",s:"New York Ave"},
{lat:40.8255,lng:-73.2025,a:"Hauppauge",s:"Veterans Hwy"},{lat:40.8230,lng:-73.2000,a:"Hauppauge",s:"Motor Pkwy"},{lat:40.8280,lng:-73.2050,a:"Hauppauge",s:"Wheeler Rd"},
{lat:40.7298,lng:-73.2106,a:"Islip",s:"Main St"},{lat:40.7270,lng:-73.2080,a:"Islip",s:"Union Ave"},
{lat:40.8338,lng:-73.1131,a:"Lake Ronkonkoma",s:"Portion Rd"},{lat:40.8310,lng:-73.1100,a:"Lake Ronkonkoma",s:"Hawkins Ave"},
{lat:40.7358,lng:-73.0822,a:"Sayville",s:"Main St"},{lat:40.7330,lng:-73.0800,a:"Sayville",s:"Montauk Hwy"},
{lat:40.9465,lng:-73.0690,a:"Port Jefferson",s:"Main St"},{lat:40.9440,lng:-73.0660,a:"Port Jefferson",s:"E Broadway"},
{lat:40.8580,lng:-73.0850,a:"Centereach",s:"Middle Country Rd"},{lat:40.8550,lng:-73.0820,a:"Centereach",s:"Mark Tree Rd"},
{lat:40.7654,lng:-73.0152,a:"Patchogue",s:"Main St"},{lat:40.7680,lng:-73.0180,a:"Patchogue",s:"E Main St"},{lat:40.7625,lng:-73.0120,a:"Patchogue",s:"Ocean Ave"},
],suffolkEast:[
{lat:40.7570,lng:-72.9393,a:"Bellport",s:"Station Rd"},{lat:40.7545,lng:-72.9370,a:"Bellport",s:"S Country Rd"},{lat:40.7600,lng:-72.9420,a:"Bellport",s:"Bellport Ln"},
{lat:40.9370,lng:-73.0280,a:"Mt Sinai",s:"N Country Rd"},{lat:40.9340,lng:-73.0250,a:"Mt Sinai",s:"Rte 25A"},
{lat:40.8030,lng:-72.8420,a:"Mastic",s:"Mastic Rd"},{lat:40.8000,lng:-72.8390,a:"Mastic",s:"Neighborhood Rd"},{lat:40.8060,lng:-72.8450,a:"Mastic",s:"William Floyd Pkwy"},{lat:40.7970,lng:-72.8360,a:"Mastic",s:"Montauk Hwy"},
{lat:40.9170,lng:-72.6620,a:"Riverhead",s:"Main St"},{lat:40.9140,lng:-72.6590,a:"Riverhead",s:"E Main St"},{lat:40.9200,lng:-72.6650,a:"Riverhead",s:"Roanoke Ave"},{lat:40.9110,lng:-72.6560,a:"Riverhead",s:"Peconic Ave"},{lat:40.9230,lng:-72.6680,a:"Riverhead",s:"Northville Tpke"},{lat:40.9080,lng:-72.6530,a:"Riverhead",s:"Griffing Ave"},
{lat:40.8820,lng:-72.5280,a:"Calverton",s:"River Rd"},{lat:40.8790,lng:-72.5250,a:"Calverton",s:"Edwards Ave"},{lat:40.8850,lng:-72.5310,a:"Calverton",s:"Nugent Dr"},
{lat:40.7980,lng:-72.7520,a:"Shirley",s:"William Floyd Pkwy"},{lat:40.7950,lng:-72.7490,a:"Shirley",s:"Montauk Hwy"},{lat:40.8010,lng:-72.7550,a:"Shirley",s:"Floyd Rd"},
{lat:40.8680,lng:-72.7800,a:"Coram",s:"Middle Country Rd"},{lat:40.8650,lng:-72.7770,a:"Coram",s:"Route 112"},{lat:40.8710,lng:-72.7830,a:"Coram",s:"Old Town Rd"},
{lat:40.8560,lng:-72.9700,a:"Selden",s:"Middle Country Rd"},{lat:40.8530,lng:-72.9670,a:"Selden",s:"College Rd"},{lat:40.8590,lng:-72.9730,a:"Selden",s:"Boyle Rd"},
{lat:40.7780,lng:-72.9150,a:"Medford",s:"Horse Block Rd"},{lat:40.7750,lng:-72.9120,a:"Medford",s:"Oregon Ave"},{lat:40.7810,lng:-72.9180,a:"Medford",s:"Granny Rd"},
{lat:40.8780,lng:-72.6300,a:"Wading River",s:"North Country Rd"},{lat:40.8750,lng:-72.6270,a:"Wading River",s:"Sound Ave"},
{lat:40.9500,lng:-72.5800,a:"Greenport",s:"Main St"},{lat:40.9470,lng:-72.5770,a:"Greenport",s:"Front St"},
{lat:40.8650,lng:-72.4800,a:"Southold",s:"Main Rd"},{lat:40.8620,lng:-72.4770,a:"Southold",s:"Youngs Ave"},
]};

// ============================================================
const AIRBNB={lat:40.725,lng:-73.44};
const INS={matt:{c:'#ff6b6b',n:'Matt',b:[16,20]},giuseppe:{c:'#4dabf7',n:'Giuseppe',b:[20,28]},pablo:{c:'#51cf66',n:'Pablo',b:[16,20]},marc:{c:'#cc5de8',n:'Marc',b:[5,10]}};
const DAYS=[
  {dt:'Mar 2',dw:'MON',sr:'6:22a',ss:'5:52p',uh:11.2,dn:1,w:true,n:''},
  {dt:'Mar 3',dw:'TUE',sr:'6:20a',ss:'5:53p',uh:11.2,dn:2,w:true,n:''},
  {dt:'Mar 4',dw:'WED',sr:'6:19a',ss:'5:55p',uh:11.3,dn:3,w:true,n:''},
  {dt:'Mar 5',dw:'THU',sr:'6:17a',ss:'5:56p',uh:11.3,dn:4,w:true,n:''},
  {dt:'Mar 6',dw:'FRI',sr:'6:16a',ss:'5:57p',uh:11.4,dn:5,w:true,n:''},
  {dt:'Mar 7',dw:'SAT',sr:'6:14a',ss:'5:58p',uh:11.4,dn:6,w:true,n:''},
  {dt:'Mar 8',dw:'SUN',sr:'7:13a',ss:'6:59p',uh:0,dn:0,w:false,n:'DST'},
  {dt:'Mar 9',dw:'MON',sr:'7:11a',ss:'7:01p',uh:11.6,dn:7,w:true,n:'EDT'},
  {dt:'Mar 10',dw:'TUE',sr:'7:09a',ss:'7:02p',uh:11.6,dn:8,w:true,n:''},
  {dt:'Mar 11',dw:'WED',sr:'7:08a',ss:'7:03p',uh:11.7,dn:9,w:true,n:''},
  {dt:'Mar 12',dw:'THU',sr:'7:06a',ss:'7:04p',uh:11.7,dn:10,w:true,n:''},
  {dt:'Mar 13',dw:'FRI',sr:'7:04a',ss:'7:06p',uh:11.8,dn:11,w:true,n:''},
  {dt:'Mar 14',dw:'SAT',sr:'7:03a',ss:'7:07p',uh:11.8,dn:12,w:true,n:''},
];
const VARS=[
  {p:.28,fx:{m:1.05},t:'g',msg:'Clean routes'},
  {p:.14,fx:{m:1.08},t:'g',msg:'Light traffic'},
  {p:.07,fx:{m:1.10},t:'g',msg:'Homeowners prepped'},
  {p:.04,fx:{m:1.15},t:'g',msg:'Perfect day'},
  {p:.07,fx:{m:.92},t:'w',msg:'Fog delays ~20min'},
  {p:.09,fx:{m:.86},t:'w',msg:'Rain slows photos'},
  {p:.07,fx:{m:.89},t:'w',msg:'LIE jammed'},
  {p:.09,fx:{m:.94,s:2},t:'w',msg:'2 gated no access'},
  {p:.08,fx:{s:1},t:'w',msg:'Interior no-show'},
  {p:.04,fx:{m:.91},t:'w',msg:'Inspector 40min late'},
  {p:.04,fx:{s:2,m:.96},t:'w',msg:'2 wrong addresses'},
  {p:.05,fx:{m:.91},t:'w',msg:'Early dark clouds'},
  {p:.025,fx:{m:.78},t:'b',msg:'Flat tire 2hrs lost'},
  {p:.02,fx:{m:.80},t:'b',msg:'Snow flurries'},
];

// ============================================================
// STATE
// ============================================================
let scenario='dense',spreadPct=20,inspections=[],allExpanded=false,totalIns=500;
let SIM={anim:false,spd:1,comp:0,rem:500,tots:{matt:0,giuseppe:0,pablo:0,marc:0},res:[]};
let aFrames=[];
const active={matt:true,giuseppe:true,pablo:true,marc:true};
const persist={slow:false,late:false,access:false};
const weather={rain:false,wind:false,fog:false,blizzard:false,clear:false};
let insTotal=500;
const dayOverrides={}; // dayOverrides[dayIdx]={rain:true,...}
const DAY_CONDS={
  rain:{emoji:'üåßÔ∏è',label:'Rain',fx:{m:.86},info:'Rain slows exterior photos. Inspectors wait for breaks, protect equipment. ‚àí14% output.'},
  traffic:{emoji:'üöó',label:'Traffic',fx:{m:.88},info:'LIE and arteries jammed. Travel time +20-40%. Biggest hit on spread Suffolk routes. ‚àí12% output.'},
  cold:{emoji:'ü•∂',label:'Cold',fx:{m:.90},info:'Below 20¬∞F ‚Äî equipment issues, slower movement, warming breaks. ‚àí10% output.'},
  noshow:{emoji:'üö´',label:'No-Shows',fx:{m:.94,s:3},info:'3+ homeowners miss interior appts. Wasted drives, 3 skipped stops. ‚àí6% output.'},
  late:{emoji:'‚è∞',label:'Late Start',fx:{m:.92},info:'Team 45-60min late. Loses ~1hr usable daylight. ‚àí8% output.'},
  fog:{emoji:'üå´Ô∏è',label:'Fog',fx:{m:.93},info:'Dense fog until 8-9 AM. Delays first 2-3 stops, unsafe early driving. ‚àí7% output.'},
};

// ============================================================
// MAP
// ============================================================
const map=L.map('map',{center:[40.78,-73.18],zoom:10,zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);
const defaultTiles='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
let tileLayer=L.tileLayer(defaultTiles,{attribution:'&copy; OSM',maxZoom:19}).addTo(map);
// Dark mode: invert tiles only (not markers)
function applyMapTheme(dark){
  const tp=document.querySelector('.leaflet-tile-pane');
  if(tp) tp.style.filter=dark?'invert(1) hue-rotate(180deg) brightness(.95) contrast(.9)':'none';
}
applyMapTheme(true);
function toggleTheme(){
  const html=document.documentElement;
  const isLight=html.getAttribute('data-theme')==='light';
  if(isLight){
    html.removeAttribute('data-theme');
    document.getElementById('themeBtn').textContent='üåô';
    applyMapTheme(true);
  } else {
    html.setAttribute('data-theme','light');
    document.getElementById('themeBtn').textContent='‚òÄÔ∏è';
    applyMapTheme(false);
  }
}
L.marker([AIRBNB.lat,AIRBNB.lng],{icon:L.divIcon({className:'',html:'<div style="background:linear-gradient(135deg,#ffaa32,#f08c00);color:#000;font-size:8px;font-weight:700;padding:3px 7px;border-radius:5px;white-space:nowrap;font-family:JetBrains Mono,monospace;box-shadow:0 2px 8px rgba(0,0,0,.5);border:1.5px solid #fff;">üè† BASE</div>',iconSize:[70,20],iconAnchor:[35,10]}),zIndexOffset:5000}).addTo(map);
L.marker([40.74,-73.57],{icon:L.divIcon({className:'county-label',html:'NASSAU',iconSize:[70,14]})}).addTo(map);
L.marker([40.76,-73.05],{icon:L.divIcon({className:'county-label',html:'SUFFOLK',iconSize:[70,14]})}).addTo(map);
L.polyline([[40.95,-73.42],[40.58,-73.42]],{color:'rgba(0,0,0,.06)',weight:1.5,dashArray:'8,6'}).addTo(map);

let mrkrs={},mrkrGroup=L.layerGroup().addTo(map);
const trucks={},halos={};
Object.keys(INS).forEach(k=>{
  trucks[k]=L.marker([AIRBNB.lat,AIRBNB.lng],{icon:L.divIcon({className:'',html:`<svg viewBox="0 0 32 14" width="26" height="12"><polygon points="1,10 4,3 10,1 23,1 29,4 31,10 29,12 1,12" fill="${INS[k].c}" fill-opacity=".85" stroke="#fff" stroke-width=".6"/><circle cx="7" cy="12" r="1.8" fill="#111" stroke="#fff" stroke-width=".3"/><circle cx="25" cy="12" r="1.8" fill="#111" stroke="#fff" stroke-width=".3"/><polygon points="4,3 10,1 10,8 5.5,8" fill="rgba(255,255,255,.12)"/></svg>`,iconSize:[26,12],iconAnchor:[13,6]}),zIndexOffset:6000});
  trucks[k].setOpacity(0);
  // Halo ‚Äî translucent warm circle that grows with completions
  halos[k]=L.circleMarker([AIRBNB.lat,AIRBNB.lng],{radius:0,fillColor:INS[k].c,color:INS[k].c,weight:1.5,fillOpacity:.08,opacity:.2,interactive:false});
});

// ============================================================
// BUILD INSPECTIONS ‚Äî live spread
// ============================================================
function buildIns(csvData){
  if(csvData){inspections=csvData;drawPins();return;}
  const ins=[];
  const pk=a=>a[Math.floor(Math.random()*a.length)];
  const jit=scenario==='dense'?.0004:scenario==='wide'?.001:.0006;
  const jf=()=>(Math.random()-.5)*jit;
  // Scale Nassau/Suffolk 42%/58% of total
  const nassauCount=Math.round(insTotal*0.42);
  const suffolkCount=insTotal-nassauCount;
  for(let i=0;i<nassauCount;i++){const b=pk(RC.nassau);ins.push({lat:b.lat+jf(),lng:b.lng+jf(),area:b.a,addr:`${Math.floor(Math.random()*980)+10} ${b.s}, ${b.a}, NY`,county:'Nassau'});}
  // Suffolk split by spreadPct
  const eastCount=Math.round(suffolkCount*(spreadPct/100));
  const westCount=suffolkCount-eastCount;
  for(let i=0;i<westCount;i++){const b=pk(RC.suffolkWest);ins.push({lat:b.lat+jf(),lng:b.lng+jf(),area:b.a,addr:`${Math.floor(Math.random()*980)+10} ${b.s}, ${b.a}, NY`,county:'Suffolk'});}
  for(let i=0;i<eastCount;i++){const b=pk(RC.suffolkEast);ins.push({lat:b.lat+jf(),lng:b.lng+jf(),area:b.a,addr:`${Math.floor(Math.random()*980)+10} ${b.s}, ${b.a}, NY`,county:'Suffolk'});}
  // Shuffle & type (80% B, 15% interior, 5% hard)
  for(let i=ins.length-1;i>0;i--){const k=Math.floor(Math.random()*(i+1));[ins[i],ins[k]]=[ins[k],ins[i]];}
  const bCut=Math.round(insTotal*0.80);
  const iCut=Math.round(insTotal*0.95);
  ins.forEach((p,i)=>{
    if(i<bCut){p.type='Basic Exterior';p.tc='#fbbf24';p.rad=5;p.ts='B';}
    else if(i<iCut){p.type='Interior';p.tc='#38bdf8';p.rad=6;p.ts='B+/A';}
    else{p.type='Hard Interior';p.tc='#fb7185';p.rad=6.5;p.ts='HARD';}
    p.id=`INS-${String(i+1).padStart(4,'0')}`;p.done=false;p.dayDone=-1;p.assignedTo=null;
  });
  inspections=ins;
  drawPins();
}

function drawPins(){
  mrkrGroup.clearLayers();mrkrs={};
  inspections.forEach(ins=>{
    const m=L.circleMarker([ins.lat,ins.lng],{radius:ins.rad,fillColor:ins.tc,color:ins.tc,weight:1,fillOpacity:.7,opacity:.3}).addTo(mrkrGroup);
    m.bindPopup(`<b>${ins.id}</b><br><span style="color:${ins.tc};font-weight:600">${ins.type}</span><br><span style="color:#aaa;font-size:9px">üìç ${ins.addr}</span><br><span style="color:#666;font-size:9px">${ins.county}</span>`);
    mrkrs[ins.id]=m;
  });
}

// ============================================================
// LIVE SPREAD ‚Äî slider redraws pins in real time
// ============================================================
let spreadTimer=null;
function liveSpread(v){
  spreadPct=parseInt(v);
  document.getElementById('spreadVal').textContent=v+'%';
  // Debounce rebuild
  clearTimeout(spreadTimer);
  spreadTimer=setTimeout(()=>{
    // Only rebuild if sim hasn't started
    if(SIM.comp===0){buildIns();updG();}
  },150);
}

// ============================================================
// SCENARIOS
// ============================================================
function setScenario(s){
  scenario=s;
  document.querySelectorAll('.scn-btn').forEach(b=>b.classList.remove('act'));
  document.getElementById(`sc-${s}`).classList.add('act');
  if(s==='dense'){spreadPct=10;document.getElementById('spreadSlider').value=10;}
  else if(s==='wide'){spreadPct=45;document.getElementById('spreadSlider').value=45;}
  else{spreadPct=20;document.getElementById('spreadSlider').value=20;}
  document.getElementById('spreadVal').textContent=spreadPct+'%';
  if(SIM.comp===0){buildIns();updG();}else fullReset();
}

// ============================================================
// PERSISTENT VARIABLE TOGGLES
// ============================================================
function togVar(k){
  persist[k]=!persist[k];
  document.getElementById(`vt-${k}`).classList.toggle('on',persist[k]);
  updG();
}

// ============================================================
// WEATHER TOGGLES ‚Äî global, apply every day
// ============================================================
function togWx(k){
  if(k==='clear'){
    Object.keys(weather).forEach(w=>weather[w]=false);
    weather.clear=!weather.clear;
  } else {
    weather[k]=!weather[k];
    weather.clear=false;
  }
  Object.keys(weather).forEach(w=>{
    const el=document.getElementById(`wx-${w}`);
    if(el){
      el.classList.toggle('on',weather[w]);
      el.classList.toggle('bad',weather[w]&&w!=='clear');
    }
  });
  updG();
}

// ============================================================
// SECTION TOGGLE ‚Äî collapsible left panel sections
// ============================================================
function togSection(id){
  const tog=document.getElementById(id+'Tog');
  const body=document.getElementById(id+'Body');
  const closing=!tog.classList.contains('closed');
  tog.classList.toggle('closed');
  if(body.classList.contains('rp-scroll')){
    // Right panel flex-based toggle
    body.classList.toggle('hide');
  } else {
    body.classList.toggle('hide');
  }
}

// ============================================================
// ADD INSPECTIONS ‚Äî only when fresh (comp===0)
// ============================================================
function addIns(n){
  if(SIM.comp>0){alert('Reset first ‚Äî can only add on fresh start');return;}
  insTotal+=n;
  document.getElementById('insCount').value=insTotal;
  document.getElementById('gT').textContent=insTotal;
  document.getElementById('subCount').textContent=insTotal;
  SIM.rem=insTotal;
  buildIns();updG();
  document.getElementById('rBdg').textContent=`${insTotal} REMAINING`;
}

function setInsCount(v){
  const n=Math.max(50,Math.min(2000,parseInt(v)||500));
  if(SIM.comp>0){document.getElementById('insCount').value=insTotal;return;}
  insTotal=n;
  document.getElementById('gT').textContent=insTotal;
  document.getElementById('subCount').textContent=insTotal;
  SIM.rem=insTotal;
  buildIns();updG();
  document.getElementById('rBdg').textContent=`${insTotal} REMAINING`;
}

// ============================================================
// FILTER ‚Äî actually hides/shows pins and affects route assignment
// ============================================================
function togF(k){
  if(k==='queue'){
    const el=document.getElementById('fb-queue');
    el.classList.toggle('on');el.classList.toggle('off');
    // Show/hide unassigned pins
    inspections.forEach(ins=>{
      if(!ins.done&&!ins.assignedTo){
        const mk=mrkrs[ins.id];
        if(mk){if(el.classList.contains('on'))mk.addTo(mrkrGroup);else mrkrGroup.removeLayer(mk);}
      }
    });
    return;
  }
  // Inspector toggle
  active[k]=!active[k];
  const el=document.getElementById(`fb-${k}`);
  el.classList.toggle('on',active[k]);
  el.classList.toggle('off',!active[k]);
  // Hide/show their completed pins
  inspections.forEach(ins=>{
    if(ins.assignedTo===k){
      const mk=mrkrs[ins.id];
      if(mk){if(active[k])mk.addTo(mrkrGroup);else mrkrGroup.removeLayer(mk);}
    }
  });
  // Hide/show truck
  if(!active[k]){trucks[k].setOpacity(0);}
  // Update dropout warning
  const dropped=Object.keys(active).filter(x=>!active[x]);
  const warn=document.getElementById('dropWarn');
  if(dropped.length){warn.classList.add('show');warn.textContent=`‚ö† ${dropped.map(x=>INS[x].n).join(', ')} removed ‚Äî reduced capacity`;}
  else warn.classList.remove('show');
  updG();
}

// ============================================================
// PANELS
// ============================================================
function togglePanel(p){
  const panel=document.getElementById(p==='l'?'lpanel':'rpanel');
  const tog=document.getElementById(p==='l'?'togL':'togR');
  const isPhone=window.innerWidth<=480;
  // On phone, close the other panel when opening one
  if(isPhone&&panel.classList.contains('hidden')){
    const otherPanel=document.getElementById(p==='l'?'rpanel':'lpanel');
    const otherTog=document.getElementById(p==='l'?'togR':'togL');
    if(!otherPanel.classList.contains('hidden')){
      otherPanel.classList.add('hidden');otherTog.classList.remove('open');
      otherTog.textContent=p==='l'?'‚óÄ':'‚ñ∂';
    }
  }
  panel.classList.toggle('hidden');tog.classList.toggle('open');
  tog.textContent=p==='l'?(panel.classList.contains('hidden')?'‚ñ∂':'‚óÄ'):(panel.classList.contains('hidden')?'‚óÄ':'‚ñ∂');
}

// ============================================================
// DAY CARDS
// ============================================================
function buildDays(){
  const dB=document.getElementById('dB');dB.innerHTML='';
  DAYS.forEach((d,i)=>{
    const c=document.createElement('div');
    c.className=`dc${d.w?'':' sun'}${d.n.includes('DST')?' dst':''}`;c.id=`dc-${i}`;
    c.innerHTML=`<div class="dc-head" onclick="togDay(${i})"><div style="display:flex;align-items:center;gap:6px"><span class="dn">${d.dw}</span><span class="dd">${d.dt}</span>${d.n?`<span style="font-size:6px;color:var(--accent)">‚ö°${d.n}</span>`:''}</div><div style="display:flex;align-items:center;gap:5px"><span class="dr" id="dr-h-${i}" style="font-size:8px"></span>${d.w?`<span class="dtg">D${d.dn}</span>`:`<span style="font-size:7px;color:#333">OFF</span>`}<span class="dc-chev">‚ñº</span></div></div>${d.w?`<div class="dc-body"><div class="di">‚òÄÔ∏è<b>${d.sr}</b> üåÖ<b>${d.ss}</b> ‚è±Ô∏è<b>${d.uh}h</b></div><div class="dr" id="dr-${i}"></div><div class="el" id="el-${i}"></div><div class="dp"><div class="dpf"></div></div><div class="dbt"><button class="b bp" id="bp-${i}" onclick="event.stopPropagation();playDay(${i})">‚ñ∂ PLAY</button><button class="b bru" id="br-${i}" onclick="event.stopPropagation();rerunDay(${i})" disabled>üîÑ RERUN</button><div class="bs${SIM.spd===1?' on':''}" onclick="event.stopPropagation();setGSpd(1,this)">1x</div><div class="bs" onclick="event.stopPropagation();setGSpd(2,this)">2x</div><div class="bs" onclick="event.stopPropagation();setGSpd(3,this)">3x</div><div class="bs" onclick="event.stopPropagation();setGSpd(4,this)">4x</div><div class="bs" onclick="event.stopPropagation();setGSpd(5,this)">5x</div></div></div>`:``}`;
    dB.appendChild(c);
  });
  DAYS.forEach((d,i)=>{if(d.w&&i>0){const b=document.getElementById(`bp-${i}`);if(b)b.disabled=true;}});
  const first=DAYS.findIndex(d=>d.w);
  if(first>=0)document.getElementById(`dc-${first}`).classList.add('open');
}
buildDays();

function togDay(i){document.getElementById(`dc-${i}`).classList.toggle('open');}
function toggleAllDays(){allExpanded=!allExpanded;DAYS.forEach((_,i)=>{const el=document.getElementById(`dc-${i}`);if(el)el.classList.toggle('open',allExpanded);});document.getElementById('expAll').textContent=allExpanded?'‚ñ≤ Collapse':'‚ñº Expand All';}
function setGSpd(s,el){
  SIM.spd=s;
  // Sync all speed buttons everywhere (global strip + per-day)
  document.querySelectorAll('.bs,.gs').forEach(b=>b.classList.remove('on'));
  // Highlight matching speed in global strip
  document.querySelectorAll('.gs').forEach(b=>{if(b.textContent===s+'x')b.classList.add('on');});
  // Highlight in per-day cards
  document.querySelectorAll('.bs').forEach(b=>{if(b.textContent===s+'x')b.classList.add('on');});
  if(el)el.classList.add('on');
}

// ============================================================
// ROUTE LOGIC ‚Äî respects active inspectors
// ============================================================
function nnSort(pts,s){const r=[...pts],o=[];let c={...s};while(r.length){let ni=0,nd=1e9;r.forEach((p,i)=>{const d=Math.hypot(p.lat-c.lat,p.lng-c.lng);if(d<nd){nd=d;ni=i;}});o.push(r.splice(ni,1)[0]);c=o[o.length-1];}return o;}

function assignR(){
  const av=inspections.filter(p=>!p.done);
  if(!av.length)return{matt:[],giuseppe:[],pablo:[],marc:[]};
  const w=av.filter(p=>p.lng<-73.48),e=av.filter(p=>p.lng>=-73.28),n=av.filter(p=>p.lat>40.82);
  const mid=av.filter(p=>!w.includes(p)&&!e.includes(p)&&!n.includes(p));
  const used=new Set();
  function pick(pool,mn,mx){const c=mn+Math.floor(Math.random()*(mx-mn+1));const f=pool.filter(p=>!used.has(p.id));const s=nnSort(f.slice(0,c*3),AIRBNB).slice(0,Math.min(c,f.length));s.forEach(p=>used.add(p.id));return s;}
  const routes={};
  const pools={matt:[...w,...mid],giuseppe:[...e,...mid],pablo:[...n,...w.slice(Math.floor(w.length/2)),...mid],marc:[...mid,...e.slice(Math.floor(e.length/2))]};
  Object.keys(INS).forEach(k=>{
    if(!active[k]){routes[k]=[];return;} // INACTIVE ‚Äî no routes
    routes[k]=pick(pools[k],INS[k].b[0],INS[k].b[1]);
  });
  return routes;
}

function rollV(){
  const a=[];
  VARS.forEach(v=>{if(Math.random()<v.p)a.push({...v});});
  if(!a.length)a.push({...VARS[0]});
  // Add persistent conditions
  if(persist.slow)a.push({p:1,fx:{m:.88},t:'w',msg:'Team not at peak (-12%)'});
  if(persist.late)a.push({p:1,fx:{m:.92},t:'w',msg:'Late starts (-8%)'});
  if(persist.access)a.push({p:1,fx:{m:.90,s:3},t:'w',msg:'High gate/access (-10%, +3 skip)'});
  // Add weather overrides
  if(weather.rain)a.push({p:1,fx:{m:.82},t:'w',msg:'üåßÔ∏è Rain ‚Äî slow photos, wet conditions (-18%)'});
  if(weather.wind)a.push({p:1,fx:{m:.88},t:'w',msg:'üí® High winds ‚Äî ladder unsafe, debris (-12%)'});
  if(weather.fog)a.push({p:1,fx:{m:.93},t:'w',msg:'üå´Ô∏è Dense fog ‚Äî delayed start, slow driving (-7%)'});
  if(weather.blizzard)a.push({p:1,fx:{m:.55,s:5},t:'b',msg:'‚ùÑÔ∏è BLIZZARD ‚Äî roads impassable, 5 skipped (-45%)'});
  if(weather.clear)a.push({p:1,fx:{m:1.12},t:'g',msg:'‚òÄÔ∏è Clear skies ‚Äî perfect conditions (+12%)'});
  return a;
}

function applyV(r,v){
  let m=1,s=0,msgs=[];
  v.forEach(x=>{if(x.fx.m)m*=x.fx.m;if(x.fx.s)s+=x.fx.s;msgs.push({text:x.msg,t:x.t});});
  const res={};
  Object.keys(r).forEach(k=>{
    if(!r[k].length){res[k]=[];return;}
    let c=Math.round(r[k].length*m);
    if(s>0){c=Math.max(1,c-Math.min(s,2));s=Math.max(0,s-2);}
    res[k]=r[k].slice(0,Math.min(c,r[k].length));
  });
  return{routes:res,msgs,mult:m};
}

// ============================================================
// ANIMATE ‚Äî only active inspectors
// ============================================================
function anim(di,routes,cb){
  if(SIM.anim)return;SIM.anim=true;
  const activeKeys=Object.keys(routes).filter(k=>routes[k].length>0);
  activeKeys.forEach(k=>{
    trucks[k].addTo(map);trucks[k].setOpacity(.9);trucks[k].setLatLng([AIRBNB.lat,AIRBNB.lng]);
    // Init halo ‚Äî small starting circle
    halos[k].setLatLng([AIRBNB.lat,AIRBNB.lng]);
    halos[k].setRadius(8);
    halos[k].addTo(map);
  });
  const all={},lines={},completed={};
  activeKeys.forEach(k=>{
    all[k]=[AIRBNB,...routes[k],AIRBNB];
    lines[k]=L.polyline(all[k].map(p=>[p.lat,p.lng]),{color:INS[k].c,weight:2.5,opacity:.4,dashArray:'5,4'}).addTo(map);
    completed[k]=0;
  });
  const total=Math.round(160/SIM.spd);let step=0;
  const pf=document.querySelector(`#dc-${di} .dpf`);
  function frame(){
    const pr=step/total;if(pf)pf.style.width=(pr*100)+'%';
    activeKeys.forEach(k=>{
      const r=all[k],pos=pr*(r.length-1),idx=Math.floor(pos),f=pos-idx;
      if(idx<r.length-1){
        const lat=r[idx].lat+(r[idx+1].lat-r[idx].lat)*f;
        const lng=r[idx].lng+(r[idx+1].lng-r[idx].lng)*f;
        trucks[k].setLatLng([lat,lng]);
        halos[k].setLatLng([lat,lng]);
      }
      const ci=Math.floor(pr*routes[k].length);
      for(let i=0;i<ci&&i<routes[k].length;i++){
        const ins=routes[k][i];
        if(!ins.done){ins.done=true;ins.dayDone=di;ins.assignedTo=k;completed[k]++;
          const mk=mrkrs[ins.id];if(mk)mk.setStyle({fillColor:INS[k].c,fillOpacity:.9,radius:7,color:'#fff',weight:1.5});}
      }
      // Grow halo: base 8 + 2 per completion, max ~70
      const haloR=8+Math.min(completed[k]*2.2,62);
      halos[k].setRadius(haloR);
      // Pulse opacity slightly with progress
      const osc=.06+Math.sin(step*.08)*.02;
      halos[k].setStyle({fillOpacity:osc,opacity:.15+completed[k]*.005});
    });
    step++;
    if(step<=total)aFrames.push(requestAnimationFrame(frame));
    else{
      // Finalize ‚Äî mark remaining, then fade out halos and trucks
      activeKeys.forEach(k=>routes[k].forEach(ins=>{if(!ins.done){ins.done=true;ins.dayDone=di;ins.assignedTo=k;completed[k]++;const mk=mrkrs[ins.id];if(mk)mk.setStyle({fillColor:INS[k].c,fillOpacity:.9,radius:7,color:'#fff',weight:1.5});}}));
      activeKeys.forEach(k=>{trucks[k].setLatLng([AIRBNB.lat,AIRBNB.lng]);trucks[k].setOpacity(0);map.removeLayer(halos[k]);});
      Object.values(lines).forEach(l=>map.removeLayer(l));
      SIM.anim=false;if(cb)cb();
    }
  }
  frame();
}

// ============================================================
// PLAY / RERUN / RESET / PLAY ALL
// ============================================================
function playDay(di,chainCb){
  if(SIM.anim)return;
  document.getElementById(`bp-${di}`).disabled=true;
  document.querySelectorAll('.dc').forEach(c=>c.classList.remove('act'));
  const card=document.getElementById(`dc-${di}`);card.classList.add('act');
  if(!card.classList.contains('open'))card.classList.add('open');
  const routes=assignR(),vars=rollV(),{routes:adj,msgs,mult}=applyV(routes,vars);
  document.getElementById(`el-${di}`).innerHTML=msgs.map(m=>`<div class="e${m.t}">${m.t==='g'?'‚úÖ':m.t==='b'?'‚ùå':'‚ö†Ô∏è'} ${m.text}</div>`).join('');
  document.getElementById('vP').innerHTML=msgs.map(m=>`<div style="color:${m.t==='g'?'var(--green)':m.t==='b'?'var(--red)':'#fcc419'}">${m.text}</div>`).join('');
  anim(di,adj,()=>{
    let dt=0;
    Object.keys(adj).forEach(k=>{const c=adj[k].length;SIM.tots[k]+=c;dt+=c;});
    SIM.comp+=dt;SIM.rem=inspections.length-SIM.comp;
    // Show per-inspector breakdown in day result
    const parts=Object.keys(adj).filter(k=>adj[k].length).map(k=>`<span style="color:${INS[k].c}">${adj[k].length}</span>`).join('+');
    document.getElementById(`dr-${di}`).innerHTML=`<span class="cc">${dt}</span> <span style="color:#555;font-size:7px">(${parts}) √ó${mult.toFixed(2)}</span>`;
    document.getElementById(`dr-h-${di}`).innerHTML=`<span style="color:var(--green);font-weight:700">${dt}‚úì</span>`;
    SIM.res[di]={routes:adj,vars,dt,mult};updG();
    card.classList.remove('act');card.classList.add('done');
    document.getElementById(`br-${di}`).disabled=false;
    if(SIM.rem>0){const nx=DAYS.findIndex((d,j)=>j>di&&d.w);if(nx>=0)document.getElementById(`bp-${nx}`).disabled=false;}
    if(SIM.rem<=0)showDone(di);
    if(chainCb)chainCb();
  });
}

function showDone(di){
  const daysPlayed=SIM.res.filter(Boolean).length;
  const d=DAYS[di];
  const scn=scenario==='dense'?'Dense Cluster':scenario==='wide'?'Wide Spread':'Standard';
  const dropped=Object.keys(active).filter(k=>!active[k]).map(k=>INS[k].n);
  const wxActive=Object.keys(weather).filter(k=>weather[k]);
  let gd=0,wd=0,bd=0;
  SIM.res.filter(Boolean).forEach(r=>r.vars.forEach(v=>{if(v.t==='g')gd++;else if(v.t==='b')bd++;else wd++;}));
  document.getElementById('doneBanner').classList.add('show');
  document.getElementById('estBox').style.display='none';
  document.getElementById('sbEst').style.display='none';
  document.getElementById('dbDays').textContent=`${daysPlayed} Working Days`;
  document.getElementById('dbDetail').innerHTML=
    `Finished <span>${d.dw} ${d.dt}</span> ¬∑ Day ${d.dn}/12<br>`+
    `Scenario: <span>${scn}</span> ¬∑ Spread: <span>${spreadPct}%</span> ¬∑ Total: <span>${insTotal}</span><br>`+
    (dropped.length?`Dropped: <span style="color:var(--red)">${dropped.join(', ')}</span><br>`:'')+
    (wxActive.length?`Weather: <span style="color:#60a5fa">${wxActive.join(', ')}</span><br>`:'')+
    (persist.slow||persist.late||persist.access?`Conditions: <span style="color:#fcc419">${[persist.slow&&'Not peak',persist.late&&'Late starts',persist.access&&'Access issues'].filter(Boolean).join(', ')}</span><br>`:'')+
    `<span>${SIM.comp}</span> done ¬∑ Matt:<span>${SIM.tots.matt}</span> Giu:<span>${SIM.tots.giuseppe}</span> Pab:<span>${SIM.tots.pablo}</span> Marc:<span>${SIM.tots.marc}</span><br>`+
    `Vars: <span style="color:var(--green)">${gd}‚úì</span> <span style="color:#fcc419">${wd}‚ö†</span> <span style="color:var(--red)">${bd}‚úó</span>`;
  document.getElementById('sBdg').textContent='‚úÖ COMPLETE';document.getElementById('sBdg').className='bdg bdg-g';
  document.getElementById('rBdg').textContent='0 LEFT';
}

function rerunDay(di){
  if(SIM.anim)return;const prev=SIM.res[di];if(!prev)return;
  // Clean up any lingering halos
  Object.keys(halos).forEach(k=>{if(map.hasLayer(halos[k]))map.removeLayer(halos[k]);});
  Object.keys(prev.routes).forEach(k=>{prev.routes[k].forEach(ins=>{ins.done=false;ins.dayDone=-1;ins.assignedTo=null;const mk=mrkrs[ins.id];if(mk){mk.setStyle({fillColor:ins.tc,fillOpacity:.7,radius:ins.rad,color:ins.tc,weight:1,opacity:.3});mk.addTo(mrkrGroup);}});SIM.tots[k]-=prev.routes[k].length;});
  SIM.comp-=prev.dt;SIM.rem=inspections.length-SIM.comp;
  document.getElementById(`dr-${di}`).innerHTML='';document.getElementById(`dr-h-${di}`).innerHTML='';
  document.getElementById(`el-${di}`).innerHTML='';
  const pf=document.querySelector(`#dc-${di} .dpf`);if(pf)pf.style.width='0%';
  document.getElementById(`dc-${di}`).classList.remove('done');
  updG();document.getElementById(`bp-${di}`).disabled=false;document.getElementById(`br-${di}`).disabled=true;
  playDay(di,null);
}

let playAllRunning=false;
function playAll(){
  if(SIM.anim||playAllRunning)return;
  const btn=document.getElementById('pallBtn');
  if(SIM.comp>0)fullReset();
  playAllRunning=true;btn.textContent='‚è∏ RUNNING...';btn.classList.add('running');btn.disabled=true;
  document.getElementById('pfastBtn').disabled=true;
  const wd=DAYS.map((d,i)=>({...d,i})).filter(d=>d.w).map(d=>d.i);
  let idx=0;
  function next(){
    if(idx>=wd.length||SIM.rem<=0){playAllRunning=false;btn.textContent='‚ñ∂‚ñ∂ PLAY ALL';btn.classList.remove('running');btn.disabled=false;document.getElementById('pfastBtn').disabled=false;return;}
    const di=wd[idx++];
    const card=document.getElementById(`dc-${di}`);if(card)card.scrollIntoView({behavior:'smooth',block:'nearest'});
    playDay(di,()=>setTimeout(next,300));
  }
  setTimeout(next,200);
}

function playAllFast(){
  if(SIM.anim||playAllRunning)return;
  // Set speed to 5x and sync UI
  setGSpd(5,null);
  const btn=document.getElementById('pfastBtn');
  const pallBtn=document.getElementById('pallBtn');
  if(SIM.comp>0)fullReset();
  playAllRunning=true;
  btn.textContent='‚ö° RUNNING...';btn.style.animation='pp 0.5s infinite';btn.disabled=true;
  pallBtn.disabled=true;
  const wd=DAYS.map((d,i)=>({...d,i})).filter(d=>d.w).map(d=>d.i);
  let idx=0;
  function next(){
    if(idx>=wd.length||SIM.rem<=0){
      playAllRunning=false;
      btn.textContent='‚ö° FAST';btn.style.animation='';btn.disabled=false;
      pallBtn.disabled=false;
      return;
    }
    const di=wd[idx++];
    const card=document.getElementById(`dc-${di}`);
    if(card){card.scrollIntoView({behavior:'smooth',block:'nearest'});if(!card.classList.contains('open'))card.classList.add('open');}
    playDay(di,()=>setTimeout(next,80)); // Minimal gap between days
  }
  setTimeout(next,100);
}

function fullReset(){
  if(SIM.anim){aFrames.forEach(f=>cancelAnimationFrame(f));aFrames=[];SIM.anim=false;}
  Object.keys(trucks).forEach(k=>{trucks[k].setOpacity(0);trucks[k].setLatLng([AIRBNB.lat,AIRBNB.lng]);if(map.hasLayer(halos[k]))map.removeLayer(halos[k]);});
  map.eachLayer(l=>{if(l instanceof L.Polyline&&l.options&&l.options.dashArray==='5,4')map.removeLayer(l);});
  SIM={anim:false,spd:1,comp:0,rem:insTotal,tots:{matt:0,giuseppe:0,pablo:0,marc:0},res:[]};
  buildIns();buildDays();updG();
  document.getElementById('sBdg').textContent='READY';document.getElementById('sBdg').className='bdg bdg-g';
  document.getElementById('rBdg').textContent=`${insTotal} REMAINING`;document.getElementById('rBdg').className='bdg bdg-o';
  document.getElementById('vP').innerHTML='‚Äî';document.getElementById('csvStatus').textContent='';
  document.getElementById('doneBanner').classList.remove('show');
  document.getElementById('estBox').style.display='';
  document.getElementById('sbEst').style.display='';
  document.getElementById('gT').textContent=insTotal;
  document.getElementById('subCount').textContent=insTotal;
  // Re-enable add buttons
  document.querySelectorAll('.abtn').forEach(b=>b.disabled=false);
  const pallBtn=document.getElementById('pallBtn');pallBtn.textContent='‚ñ∂‚ñ∂ PLAY ALL';pallBtn.classList.remove('running');pallBtn.disabled=false;
  const pfastBtn=document.getElementById('pfastBtn');pfastBtn.textContent='‚ö° FAST';pfastBtn.style.animation='';pfastBtn.disabled=false;
  playAllRunning=false;
}

function updG(){
  document.getElementById('gC').textContent=SIM.comp;document.getElementById('gR').textContent=SIM.rem;
  document.getElementById('gP').style.width=(SIM.comp/Math.max(inspections.length,1)*100)+'%';
  document.getElementById('rBdg').textContent=`${SIM.rem} REMAINING`;
  document.getElementById('gT').textContent=insTotal;
  document.getElementById('tM').textContent=SIM.tots.matt;document.getElementById('tG').textContent=SIM.tots.giuseppe;
  document.getElementById('tP').textContent=SIM.tots.pablo;document.getElementById('tMa').textContent=SIM.tots.marc;
  document.getElementById('pC').textContent=SIM.comp;document.getElementById('pR').textContent=SIM.rem;
  document.querySelectorAll('.abtn').forEach(b=>b.disabled=SIM.comp>0);

  // Per-inspector daily ranges
  const ranges={matt:[18,20],giuseppe:[22,28],pablo:[16,20],marc:[5,10]};

  // CLEAN baseline ‚Äî full team, no penalties
  let cleanLo=0,cleanHi=0;
  Object.keys(ranges).forEach(k=>{cleanLo+=ranges[k][0];cleanHi+=ranges[k][1];});
  const target=SIM.rem>0?SIM.rem:insTotal;
  const cleanDaysLo=cleanHi>0?Math.ceil(target/cleanHi):99;
  const cleanDaysHi=cleanLo>0?Math.ceil(target/cleanLo):99;
  const cleanMid=Math.round((cleanDaysLo+cleanDaysHi)/2);

  // CURRENT ‚Äî active team + all penalties
  const act=Object.keys(active).filter(k=>active[k]);
  const actCount=act.length;
  let loDaily=0,hiDaily=0;
  act.forEach(k=>{loDaily+=ranges[k][0];hiDaily+=ranges[k][1];});

  let penMult=1;
  if(persist.slow)penMult*=.88;
  if(persist.late)penMult*=.92;
  if(persist.access)penMult*=.90;
  if(weather.rain)penMult*=.82;
  if(weather.wind)penMult*=.88;
  if(weather.fog)penMult*=.93;
  if(weather.blizzard)penMult*=.55;
  if(weather.clear)penMult*=1.12;

  const penLo=Math.round(loDaily*penMult);
  const penHi=Math.round(hiDaily*penMult);

  const penDaysLo=penHi>0?Math.ceil(target/penHi):99;
  const penDaysHi=penLo>0?Math.ceil(target/penLo):99;
  const penMid=Math.round((penDaysLo+penDaysHi)/2);
  const lagMid=penMid-cleanMid;
  const lagLo=penDaysLo-cleanDaysLo;
  const lagHi=penDaysHi-cleanDaysHi;

  // Update estimate UI
  document.getElementById('estTeam').textContent=`${actCount} inspector${actCount!==1?'s':''}`;
  document.getElementById('estTeam').className='est-val'+(actCount<=2?' crit':actCount===3?' warn':' good');

  if(SIM.comp>0){
    const played=SIM.res.filter(Boolean).length;
    const avg=SIM.comp/played;
    const need=Math.ceil(SIM.rem/avg);
    const estFin=played+need;
    document.getElementById('pF').textContent=SIM.rem<=0?'DONE ‚úÖ':`Day ${Math.min(played+need,12)}`;
    document.getElementById('estDaily').textContent=`~${Math.round(avg)}/day actual`;
    document.getElementById('estFinish').textContent=SIM.rem<=0?'DONE ‚úÖ':`Day ${Math.min(estFin,12)}${estFin>12?'+':''}`;
    document.getElementById('estFinish').className='est-val'+(estFin>12?' crit':estFin>=11?' warn':' good');
    const buf=12-Math.min(estFin,99);
    document.getElementById('estBuffer').textContent=buf<=0?'None ‚Äî tight':'~'+buf+' day'+(buf>1?'s':'');
    document.getElementById('estBuffer').className='est-val'+(buf<=0?' crit':buf<=1?' warn':' good');

    // Lag based on actual pace vs clean
    const actualLag=estFin-cleanMid;
    document.getElementById('estLag').textContent=actualLag<=0?'None':`+${actualLag} day${actualLag>1?'s':''}`;
    document.getElementById('estLag').className='est-val'+(actualLag>=4?' crit':actualLag>=2?' warn':' good');
    // Second box ‚Äî estimated with current conditions
    document.getElementById('eF').textContent=SIM.rem<=0?'DONE ‚úÖ':`Day ${estFin}${estFin>12?'+':''}`;
    document.getElementById('eF').style.color=estFin>12?'var(--red)':estFin>=11?'var(--accent)':'var(--blue)';
    document.getElementById('eLag').textContent=actualLag<=0?'0':`+${actualLag}`;
    document.getElementById('eLag').style.color=actualLag>=4?'var(--red)':actualLag>=2?'var(--accent)':'var(--blue)';
    const over=estFin>12?estFin-12:0;
    document.getElementById('eOver').textContent=over>0?`+${over} day${over>1?'s':''}`:'None';
    document.getElementById('eOver').style.color=over>0?'var(--red)':'var(--green)';
  }else{
    document.getElementById('pF').textContent=penDaysLo===penDaysHi?`~Day ${Math.min(penDaysLo,12)}${penDaysLo>12?'+':''}`:`~Day ${Math.min(penDaysLo,12)}‚Äì${Math.min(penDaysHi,12)}${penDaysHi>12?'+':''}`;
    document.getElementById('estDaily').textContent=penLo===penHi?`~${penLo}/day`:`~${penLo}‚Äì${penHi}/day`;
    document.getElementById('estDaily').className='est-val'+(penHi<30?' crit':penHi<45?' warn':'');
    document.getElementById('estFinish').textContent=penDaysLo===penDaysHi?`Day ${Math.min(penDaysLo,12)}${penDaysLo>12?'+':''}`:`Day ${Math.min(penDaysLo,12)}‚Äì${Math.min(penDaysHi,12)}${penDaysHi>12?'+':''}`;
    document.getElementById('estFinish').className='est-val'+(penDaysLo>12?' crit':penDaysLo>=11?' warn':' good');
    const bufMin=Math.max(0,12-penDaysHi);
    const bufMax=Math.max(0,12-penDaysLo);
    document.getElementById('estBuffer').textContent=bufMax<=0?'None ‚Äî over 12':'~'+bufMin+(bufMin!==bufMax?'‚Äì'+bufMax:'')+' day'+(bufMax>1?'s':'');
    document.getElementById('estBuffer').className='est-val'+(bufMax<=0?' crit':bufMin<=1?' warn':' good');

    // Lag
    document.getElementById('estLag').textContent=lagMid<=0?'None':`+${lagLo===lagHi?lagMid:lagLo+'‚Äì'+lagHi} day${lagHi>1?'s':''}`;
    document.getElementById('estLag').className='est-val'+(lagMid>=4?' crit':lagMid>=2?' warn':' good');
    // Second box
    document.getElementById('eF').textContent=`Day ${penMid}${penMid>12?'+':''}`;
    document.getElementById('eF').style.color=penMid>12?'var(--red)':penMid>=11?'var(--accent)':'var(--blue)';
    document.getElementById('eLag').textContent=lagMid<=0?'0':`+${lagMid}`;
    document.getElementById('eLag').style.color=lagMid>=4?'var(--red)':lagMid>=2?'var(--accent)':'var(--blue)';
    const over=penMid>12?penMid-12:0;
    document.getElementById('eOver').textContent=over>0?`+${over} day${over>1?'s':''}`:'None';
    document.getElementById('eOver').style.color=over>0?'var(--red)':'var(--green)';
  }
}

// ============================================================
// CSV
// ============================================================
const csvZone=document.getElementById('csvZone');
const csvInput=document.getElementById('csvInput');
csvZone.addEventListener('dragover',e=>{e.preventDefault();csvZone.classList.add('drag');});
csvZone.addEventListener('dragleave',()=>csvZone.classList.remove('drag'));
csvZone.addEventListener('drop',e=>{e.preventDefault();csvZone.classList.remove('drag');if(e.dataTransfer.files.length)parseCSV(e.dataTransfer.files[0]);});
csvInput.addEventListener('change',e=>{if(e.target.files.length)parseCSV(e.target.files[0]);});
function parseCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').filter(l=>l.trim());
    const header=lines[0].toLowerCase();
    const start=header.includes('lat')||header.includes('address')?1:0;
    const data=[];
    for(let i=start;i<lines.length&&data.length<500;i++){
      const cols=lines[i].split(',').map(c=>c.trim().replace(/^"|"$/g,''));
      if(cols.length<2)continue;
      const lat=parseFloat(cols[0]),lng=parseFloat(cols[1]);
      if(isNaN(lat)||isNaN(lng))continue;
      const addr=cols[2]||'Unknown';
      const tr=(cols[3]||'B').toUpperCase();
      let type='Basic Exterior',tc='#fbbf24',rad=3.5,ts='B';
      if(tr.includes('HARD')||tr==='H'){type='Hard Interior';tc='#fb7185';rad=5;ts='HARD';}
      else if(tr.includes('INT')||tr==='A'||tr==='B+'){type='Interior';tc='#38bdf8';rad=4.5;ts='B+/A';}
      data.push({lat,lng,area:addr.split(',')[1]?.trim()||'',addr,county:lng>-73.42?'Suffolk':'Nassau',type,tc,rad,ts,id:`INS-${String(data.length+1).padStart(4,'0')}`,done:false,dayDone:-1,assignedTo:null});
    }
    if(data.length){
      document.getElementById('csvStatus').textContent=`‚úì ${data.length} loaded`;
      buildIns(data);SIM.rem=data.length;updG();
    }
  };
  reader.readAsText(file);
}

// Init
buildIns();
// Phone: hide right panel by default, show only left
if(window.innerWidth<=480){
  document.getElementById('rpanel').classList.add('hidden');
  document.getElementById('togR').classList.remove('open');
  document.getElementById('togR').textContent='‚óÄ';
}
</script>
</body>
</html>
